{% extends 'project/project-summary.html' %}
{% load urs_tags %}

<!--Content part starts-->

{% block content %}
<div class="clear"></div>
<!--Content part starts-->
<section class="content-part">
	<div class="row">
	
	<div class=" white-box ">
<!--    	<img src="/static/img/wip-img.jpg" alt="">-->
        <div id="gwContainer" className="col-md-12 gantt" style="padding-top: '25px', position: 'relative', height: 'auto', width:'100%'"></div>
    </div>
<div class="green-box">
   <div class="green-box-lft">
      <h2>Activities</h2>
      <div class="green-content">
         <div id="boxscroll-atm">
            <ul>
               {% if activity_list %}
               {% for i in activity_list %}
               <li><a href="javascript:void(0);">{{i.name}}<span>({{i.get_activity_type_display}}) <i class="fa fa-edit" style="float:right" onclick="activity('{{i.slug}}','{{project.slug}}')"></i></span>
               {% get_user_permission request as user_obj %}
<!--                    {% if user_obj.is_admin_user == True %}-->
                  
                      <!-- <a href="/managing/Activity/ActivityForm/edit/{{i.slug}}/?key={{project.slug}}"></a> -->
                  
<!--                    {% endif %}-->
                    </a>
               </li>
               {% endfor %}
               {% else %}
               <li><a href="javascript:void(0);"> No activites are created</a></li>
               {% endif %}
            </ul>
         </div>
         <div class="clear"></div>
                  {% get_user_permission request as user_obj %}
                    {% if user_obj.is_admin_user == True %}
                    <a class="add-task" href="/managing/Activity/ActivityForm/add/?slug={{project.slug}}">Add Activity</a>
                    {% endif %}
      </div>
   </div>
      <div class="green-box-lft">
         <h2>Tasks</h2>
         <div class="green-content">
            <div id="boxscroll-atm1">
               <ul>
                  {% if task_list %}
                  {% for task in task_list %}
                  <li><a href="javascript:void(0);">{{task.name}} <span>{{task.start_date | date:"jS M"}} - {{task.end_date | date:'jS M'}}{% if task.status != 2 %}<i class="fa fa-edit" style="float:right" onclick="task('{{task.slug}}','{{project.slug}}')"></i>{% endif %}</span>
<!--                    {% get_user_permission request as user_obj %}-->
<!--                    {% if user_obj.is_admin_user == True %}-->
<!--                     <a class="add-task" href="/managing/Task/TaskForm/edit/{{task.slug}}/?key={{project.slug}}"><i class="fa fa-edit"></i> </a></a>-->
<!--                     {% endif %}-->
                    </a>
                  </li>
                  {% endfor %}
                  {% else %}
                  <li><a href="javascript:void(0);"> No tasks are created </a></li>
                  {% endif %}
               </ul>
            </div>
            <div class="clear"></div>
            {% get_user_permission request as user_obj %}
                    {% if user_obj.is_admin_user == True %}
            <a class="add-task" href="/managing/Task/TaskForm/add/?slug={{project.slug}}">Add Task</a>
                {% endif %}
         </div>
      </div>
      <div class="green-box-lft">
         <h2>Milestones</h2>
         <div class="green-content">
            <div id="boxscroll-atm2">
               <ul>
                  {% if milestone %}
                  {% for mile in milestone %}
                  <li><a href="javascript:void(0);">{{mile.name}} <span>(Due - {{mile.overdue|date:'jS M'}}){% if mile.status != 2 %}<i class="fa fa-edit" style="float:right" onclick="milestone('{{mile.slug}}','{{project.slug}}')"></i>{% endif %}</span>
<!--                  {% get_user_permission request as user_obj %}-->
<!--                    {% if user_obj.is_admin_user == True %}-->
<!--                                          <a class="add-task" href="/managing/Milestone/MilestoneForm/edit/{{mile.slug}}/?key={{project.slug}}"><i class="fa fa-edit"></i> </a> </a>-->
<!--                  {% endif %}-->
                    </a>
                  </li>
                  {% endfor %}
                  {% else %}
                  <li><a href="javascript:void(0);"> No milestones</a></li>
                  {% endif %}
               </ul>
            </div>
            <div class="clear"></div>
                {% get_user_permission request as user_obj %}
                    {% if user_obj.is_admin_user == True %}
                <a class="add-task" href="/managing/Milestone/MilestoneForm/add/?slug={{project.slug}}">Add Milestone</a>
                {% endif %}
         </div>
      </div>
   </div>
</div>
</section>
<!--Content part Ends-->

{% endblock %}

{% block script %}
<!-- jQuery (necessary for JavaScript plugins) -->
<script type="text/javascript" src="/static/js/jquery.selectbox-0.2.js"></script>
<script type="text/javascript" src="/static/js/ddsmoothmenu.js"></script>
<script type="text/javascript" src="/static/js/jquery.mmenu.min.all.js"></script>
<script type="text/javascript" src="/static/js/common.js" /></script>
<!--<script type="text/javascript" src="js/jquery.scrollbox.js"></script>-->
<script src="/static/js/jquery.nicescroll.min.js"></script>
 <script src="/static/js/easyResponsiveTabs.js" type="text/javascript"></script>

<script>
function activity(name,slug) {
    window.location.href="/managing/Activity/ActivityForm/edit/"+ name +"/?key="+slug;
}
function task(name,slug) {
    window.location.href="/managing/Task/TaskForm/edit/"+ name +"/?key="+slug;
}

function milestone(name,slug) {
    window.location.href="/managing/Milestone/MilestoneForm/edit/"+ name +"/?key="+slug;
}
</script>
<script>
//Toggle
		
	$('.user-menu').on('click',function(){
		$('.dropdown-menu').slideDown(350);
	
	});
	$('.select-down').on('click',function(){
        $('.dropdown-menu1').slideDown(350);
          
    });
	
	$(document).ready(function(e) {	
		/*Content Show/Hide */
		$('.hide-cont').hide();
		$('.close-cont').hide();
		$('.view-cont').click(function(){
			$('.hide-cont').slideDown(350);
			$('.close-cont').show();
			$('.view-cont').hide();
		});
		$('.close-cont').click(function(){
			$('.hide-cont').slideUp(350);
			$('.close-cont').hide();
			$('.view-cont').show();
		});	
		$(document).trigger( "click" );
	});
	
	$(document).click(function(){
	
		$('.user-menu, .select-down').click(function(event){
			event.stopPropagation();
		});
	
		$('.dropdown-menu, .dropdown-menu1').slideUp(350);	 
	
	});		 
</script>

    <script type="text/javascript">
   
	
	var expanded = false;

function showCheckboxes() {
  var checkboxes = document.getElementById("checkboxes");
  if (!expanded) {
    checkboxes.style.display = "block";
    expanded = true;
  } else {
    checkboxes.style.display = "none";
    expanded = false;
  }
}
    </script>
    <script>
  $(document).ready(function() {
  
    $("#boxscroll-atm").niceScroll("#boxscroll-atm ul",{cursorborder:"",cursorcolor:"#949494",boxzoom:true});
	// First scrollable DIV
	$("#boxscroll-atm1").niceScroll("#boxscroll-atm1 ul",{cursorborder:"",cursorcolor:"#949494",boxzoom:true});
	$("#boxscroll-atm2").niceScroll("#boxscroll-atm2 ul",{cursorborder:"",cursorcolor:"#949494",boxzoom:true});

    
  });
</script>
<script type="text/javascript">
    $(document).ready(function () {
        $('#horizontalTab').easyResponsiveTabs({
            type: 'default', //Types: default, vertical, accordion           
            width: 'auto', //auto or any width like 600px
            fit: true,   // 100% fit in a container
            closed: 'accordion', // Start closed if in accordion view
            activate: function(event) { // Callback function if tab is switched
                var $tab = $(this);
                var $info = $('#tabInfo');
                var $name = $('span', $info);

                $name.text($tab.text());

                $info.show();
            }
        });
		});
</script>
<script src="/static/js/jquery.simplePopup.js" type="text/javascript"></script>
<script type="text/javascript">
$(document).ready(function(){
    $('#myBtn1').click(function(){
	$('#pop3').simplePopup();
    });
});
</script>

<!---datepicker script-->
<script src="http://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>
<script>
	$(function() {
	$( ".datepicker" ).datepicker({
	showOn: "button",
	buttonImage: "img/calender-icon.png", 
	buttonImageOnly: true
	});
	});
</script>
<link href="/static/css/jsgantt.css" rel="stylesheet" type="text/css" />
  <script src="/static/js/jsgantt.js" type="text/javascript"></script>
<script>
    var jsonData = {{taskdict|safe}}
    var g = new JSGantt.GanttChart(document.getElementById('gwContainer'), 'week');
    // console.log(jsonData.tasks);
    // Get today and tomorrows date
    var cur = new Date();
    var tom = new Date();
    tom.setDate(tom.getDate() + 1);
    var curDate = cur.getFullYear() + '-' +
      (('' + (cur.getMonth() + 1)).length < 2 ? '0' : '') + (cur.getMonth() + 1) + '-' +
      (('' + cur.getDate()).length < 2 ? '0' : '') + cur.getDate();

    var tomDate = tom.getFullYear() + '-' +
      (('' + (tom.getMonth() + 1)).length < 2 ? '0' : '') + (tom.getMonth() + 1) + '-' +
      (('' + tom.getDate()).length < 2 ? '0' : '') + tom.getDate();
    // Get today and tomorrows date
    $.each(jsonData.supercategories, function (i) {
      superId = 1, activity_type = 'Core', taskCompletion = 0, superName = 'Super Category';
      if (this.id != null) {
        superId = this.id;
      }
      superName = this.name;
      var superDesc = this.description;
      if (superName.toLowerCase() != "location") {
        g.AddTaskItem(new JSGantt.TaskItem(superId, superName, '', '', 'ggroupblack', '', 0, null, 0, 1, 0, 1, '',
          '', superDesc, g));
      }
      // console.log("Super");
      // console.log(superId, superName, '', '', 'ggroupblack', '', 0, null, 0, 1, 0, 1, '',
      //   '', superDesc);
    });
    $.each(jsonData.activities, function (i) {
      var activityId = 11,
        superId = 1,
        activity_type = 'Core',
        taskCompletion = 0,
        activityName = 'Activity';
      if (this.id != null) {
        activityId = this.id.toString();
      }
      if (this.super_category != null) {
        superId = this.super_category;
        if (this.id != null) {
          activityId = this.super_category.toString() + activityId;
        }
      }
      // console.log("ActID", activityId);
      activityName = this.name;
      var activityDesc = this.description;
      g.AddTaskItem(new JSGantt.TaskItem(activityId, activityName, '', '', 'ggroupblack', '', 0, '', 0, 2, superId,
        1, '', '',
        activityDesc, g));
      // console.log("Act");
      // console.log(activityId, activityName, '', '', 'ggroupblack', '', 0, '', 0, 2, superId,1, '', '',activityDesc);
    });
    $.each(jsonData.tasks, function (i) {
      var taskId = 111,
        tempId = 1,
        activityId = 11,
        superId = 1,
        activity_type = 'Core',
        taskCompletion = 0,
        taskName = 'Task',
        taskStatus = 'gtaskred',
        eStartDate = curDate,
        eEndDate = tomDate;
      if (this.id != null) {
        taskId = this.id;
        tempId = this.id;
      }
      if (this.activity != null) {
        activityId = this.activity;
      }
      // activity = jsonData.activities.filter(function( i ) {
      //   if(i.id == activityId){return i.super_category;}
      // });
      $.each(jsonData.activities, function () {
        if (this.id == activityId) {
          activity_type = this.activity_type;
          if (this.super_category != null) {
            superId = this.super_category;
          }
        }
      });
      if (superId != null && activityId != null && taskId != null) {
        taskId = superId.toString() + activityId.toString() + taskId.toString();
      }
      if (superId != null && activityId != null) {
        activityId = superId.toString() + activityId.toString();
      }
      activityId = parseInt(activityId);
      // console.log("TaskID", taskId);
      taskName = this.name;
      eStartDate = this.expected_start_date;
      eEndDate = this.expected_end_date;
      if (activity_type == "Core") {
        switch (this.status) {
          case "Ongoing":
            taskStatus = 'gtaskblue';
            break;
          case "Open":
            taskStatus = 'gtaskyellow';
            break;
          case "Close":
            taskStatus = 'gtaskgreen';
            break;
          default:
            taskStatus = 'gtaskblue';
            break;
        };
      }
      // For Milestones
      var completionDate = this.actual_end_date;
      console.log('Complete date', completionDate);
      $.each(jsonData.milestones, function (i) {
        var mileId = 111, mileStatus = 'gmilestone redmile '
        depTask = [];
        depTask = this.task;
        mileName = this.name;
        if (this.id != null) {
          mileId = this.id;
        }
        // if (depTask.length == 1) {
        var ln = depTask.length;
        ln--;
        console.log('depTask', depTask[0]);
        if (depTask[ln] == tempId) {
          var d1 = new Date(eEndDate);
          var d2 = new Date(eEndDate);
          d1.setDate(d1.getDate() + 1);
          d2.setDate(d2.getDate() + 11);
          var mileStart = d1.getFullYear() + '-' +
            (('' + (d1.getMonth() + 1)).length < 2 ? '0' : '') + (d1.getMonth() + 1) + '-' +
            (('' + d1.getDate()).length < 2 ? '0' : '') + d1.getDate();

          var mileEnd = d2.getFullYear() + '-' +
            (('' + (d2.getMonth() + 1)).length < 2 ? '0' : '') + (d2.getMonth() + 1) + '-' +
            (('' + d2.getDate()).length < 2 ? '0' : '') + d2.getDate();
          //Check for milestone complete or calculate delay
          if (completionDate == null) {
            mileStatus = 'gmilestone redmile '
          } else {
            var d3 = new Date(this.overdue);
            var d4 = new Date(completionDate);
            var timeDiff = (d3.getTime() + 86400) - d4.getTime();
            var diffDays = Math.ceil(timeDiff / 86400000);
            console.log('DiffDays', diffDays);
            if (diffDays < 0) {
              var dur = Math.abs(diffDays);
              if (dur < 8) { mileName += " - Delayed by " + dur + " day(s)" };
              if (dur >= 8 && dur < 30) { dur = Math.floor(dur / 7); mileName += " - Delayed by " + dur + "+ week(s)" };
              if (dur >= 30 && dur < 365) { dur = Math.floor(dur / 30); mileName += " - Delayed by " + dur + "+ month(s)" };
              if (dur >= 365) { dur = Math.floor(dur / 360); mileName += " - Delayed by " + dur + "+ year(s)" };
              console.log('Diff days', mileName);
            } else {
              mileStatus = 'gmilestone greenmile '
              var dur = Math.abs(diffDays);
              if (dur == 0) { mileName += " - On track" };
              if (dur < 8) { mileName += " - Ahead by " + dur + " day(s)" };
              if (dur >= 8 && dur < 30) { dur = Math.floor(dur / 7); mileName += " - Ahead by " + dur + "+ week(s)" };
              if (dur >= 30 && dur < 365) { dur = Math.floor(dur / 30); mileName += " - Ahead by " + dur + "+ month(s)" };
              if (dur >= 365) { dur = Math.floor(dur / 360); mileName += " - Ahead by " + dur + "+ year(s)" };
              console.log('Diff days', mileName);
            }
          }
          g.AddTaskItem(new JSGantt.TaskItem(mileId, mileName, mileStart, mileEnd,
            mileStatus, '', 1, '', null, 0, activityId, 1, '', '', '', g));
        }
        // } else {
        //   var prevDate, maxDate;
        //   $.each(depTask, function () {
        //     var depValue = this.valueOf();
        //     $.each(jsonData.tasks,function(){
        //       if(this.id == depValue){

        //       }
        //     });
        //     console.log('Dep', this.valueOf(), depTask);
        //   });
        // }
        // g.AddTaskItem(new JSGantt.TaskItem(66141, 'Milestone', '2017-05-30T18:30:00Z', '2017-06-07T00:00:00Z',
        //   'gmilestone', '', 1, '', 10, 0, 6614, 1, '661496FS', '', '', g));
      });


      //Draw task after drawing milestone
      g.AddTaskItem(new JSGantt.TaskItem(taskId, taskName, eStartDate, eEndDate, taskStatus, '', 0,
        '', 0, 0, activityId, 1, '', '', '', g));
      // console.log("Task");
      // console.log(taskId, this.id, superId, taskName, eStartDate, eEndDate, taskStatus, '', 0,
      //   '', 0, 0, activityId, 1, '', '', '');

    });

    g.setShowStartDate(0);
    g.setShowEndDate(0);
    g.setShowRes(0);
    g.setShowDeps(0);
    g.setShowDur(0);
    g.setUseToolTip(0);
    g.setWeekColWidth(50);
    g.setWeekMajorDateDisplayFormat('mon yyyy');
    g.setWeekMinorDateDisplayFormat('W w');
    // g.setScrollTo('today');
    g.Draw();

    function collision($div1, $div2) {
      var x1 = $div1.offset().left;
      var y1 = $div1.offset().top;
      var h1 = $div1.outerHeight(true);
      var w1 = $div1.outerWidth(true);
      var b1 = y1 + h1;
      var r1 = x1 + w1;
      var x2 = $div2.offset().left;
      var y2 = $div2.offset().top;
      var h2 = $div2.outerHeight(true);
      var w2 = $div2.outerWidth(true);
      var b2 = y2 + h2;
      var r2 = x2 + w2;

      if (b1 < y2 || y1 > b2 || r1 < x2 || x1 > r2) return false;
      return true;
    }
    var count = 0,
      padding = 25,
      arrayTask = [],
      collide = false;
    $('.gselector').hide();
    $(document).ready(function () {
      var previous = null;
      var prePrevious = null;
      var mile = false;
      $(".gtaskbarcontainer").each(function (index) {
        currParent = $(this).parent().parent().parent();
        listParent = currParent.attr('id').replace('row', '');
        if ($(this).hasClass('gmilecontainer')) {
          mile = true;
        }
        if (previous && $(this).parent().parent().parent().attr('id') == $(previous).parent().parent().parent()
          .attr('id')) {
          // console.log("This ID", $(this).attr('id'), mile);
          if (mile) {

          }
          if (collision($(this), $(previous)) || collision($(this), $(prePrevious))) {
            $('#' + currParent.attr('id') + " .gtaskbarcontainer").each(function () {
              if ($(this).css('top') == '-5px') {
                $(this).css('top', '0px');
              }
            });
            collide = true;
            $(this).css('top', parseInt($(previous).css('top')) + padding + 'px');
            if (count == 0) {
              $(previous).css('top', '0px');
              count++;
            }
            listParentDiv = $('#' + listParent);
            if (parseInt(currParent.css('height')) <= parseInt($(this).css('top'))) {
              listParentDiv.css('height', parseInt(listParentDiv.css('height')) + 25 + 'px');
              currParent.css({
                'height': parseInt(currParent.css('height')) + 25 + 'px',
                'vertical-align': 'top'
              });
            }
          }
        } else {
          count = 0;
          arrayTask = [];
          collide = false;
          $('#' + currParent.attr('id') + ' .gtaskbarcontainer').css({
            top: '-5px'
          });
          mile = false;
        }
        prePrevious = previous;
        previous = this;
      });
    });
  </script>

<script>
{% endblock %}

