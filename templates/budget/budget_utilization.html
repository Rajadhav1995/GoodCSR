{% extends 'base.html' %}
{% load urs_tags %}
{% block section %}
{% endblock %}
{% block content %}

</br>

<section class="content-part forms_section">
<div class="row">

	<div class="content-top margin-top">
      <div class="select-area">
      
         <form id="filter_form" action=".?slug={{project_slug}}&budget_id={{budget_id}}" method = "get" >
                 <input type="hidden" name="slug" value="{{project_slug}}">
                <input type="hidden" name="budget_id" value="{{budget_id}}">
      	<label>See Data as </label>
        <div class="small-select">
                <select name="year" id="year" class = "form-control" style="margin-left:5px">
                    <option value = "">Select Year </option>
                    {% for i in years_list %}
                    <option value="{{i}}">{{i}}</option>
                    {% endfor %}
                </select>
        </div> &nbsp;&nbsp;
         <div class="small-select" style="margin-left:10px">
                <select name="quarter" id="quarter" class = "form-control" >
                    <option value = "">Select Quarter </option>
                    {% for i,j in quarter_selection_list.items %}
                    <option value="{{i}}">{{j}}</option>
                    {% endfor %}
                </select>
                </div>
        <!--<select name="lang" class="select_box ">
            <option>Select Quarters</option>
            <option>Quarter1</option>
            <option>Quarter2</option>
        </select>-->
        </form>
         </div>
    </div>
    <div class="white-box">
        <div class="budget_create">
            <h3>Budget Utilization for <a class="active" href="/manage/project/budget/view/?slug={{projectobj.slug}}"> {{projectobj.name|title}} </a></h3>
            <p> Update Budget Utilized Items</p>

{% if quarter_key %}
<form id="ic_form" action=".?slug={{project_slug}}&budget_id={{budget_id}}" method = "post" enctype="multipart/form-data" >{% csrf_token %}
<input type="hidden" name="count" value="{{span_length}}">

        <div id="boxscroll1" class="table-scroll">
                <input type="hidden" name="count" value="6">
                <input type="hidden" name="slug" value="{{project_slug}}">
                <input type="hidden" name="budget_id" value="{{budget_id}}">
                <div class="sticky-table sticky-headers sticky-ltr-cells table-wrap">
                    <table class="table table-striped table-striped " cellpadding="0" cellspacing="0" border="0">
                        <thead>
                            <tr class="sticky-row">
                              <td class = "sticky-cell table_first" colspan="5">&nbsp;</td>	
                              {% for i,j in quarter_list.items %}
                                    <td class="table-head" colspan="7">{{j}}</th>
                            {% endfor %}
                            </tr>
                            <tr class="sticky-row">
                                <th class="sticky-cell">&nbsp;</th>
                                <th class="sticky-cell">Super Category</th>
                                <th class="sticky-cell">Heading</th>
                                <th class="sticky-cell">Subheading</th>
<!--                                <th class="fixed-side">Line Total</th>-->
<!--                                <th class="fixed-side">Line Total Utilized</th>-->
                                <th class="sticky-cell">Unit Type</th>
                                {% for i,j in quarter_list.items %}
                                <th> No. of unit </th>
                                <th> Rate </th>
                                <th> Total Planned </th>
                                <th> Total Utilized </th>
                                <th> Variance </th>
                                <th> Comment </th>
                                <th> Attachment </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody class="budget_section">
                        {% for j in budget_period %}
                        {% with forloop.counter as rnum %}
                        <tr class = "data_row">
                            {% get_budget_lineitem j projectobj as lineitemobj %}
                            <td class="sticky-cell">{{rnum}}</td>
                            <td class="sticky-cell"> {{lineitemobj.category.name}}</td>
                            <td class="sticky-cell"> {{lineitemobj.heading.name}} </td>
                            <td class="sticky-cell"> {{lineitemobj.subheading}} </td>
<!--                            {% get_line_total j projectobj as line_total %}-->
<!--                            <td class="fixed-side"> {{line_total}} </td>-->
<!--                            {% get_utlizedline_total j projectobj as utlized_line_total %}-->
<!--                            <td class="fixed-side"><input type="number" class = "totalutlized" name = "utlized_{{j}}" id="utilized_{{j}}" readonly="readonly" value ="{{utlized_line_total}}"></td>-->
                             <td class="sticky-cell"> {{lineitemobj.unit_type}}  </td>
                            {% for i,v in quarter_list.items %}
                            {% get_quarter_details j i projectobj as line_itemobj %}
                               <td> {{line_itemobj.unit}} </td>
                                <td> {{line_itemobj.rate}} </td>
                                <td name = "planned-cost_{{i}}_{{j}}" class ="planned-cost" id="planned-cost_{{i}}_{{j}}"> {{line_itemobj.planned_unit_cost}} </td>
<!--                                 <td> <input type="number" name = "planned-cost_{{i}}_{{j}}" class ="planned-cost" id="planned-cost_{{i}}_{{j}}" readonly="readonly" value ="{{line_itemobj.planned_unit_cost}}"> </td>-->
                                 
                                 <td> <input type="number" name = "utilized_unit_cost_{{i}}_{{j}}_{{line_itemobj.id}}"  id = "utilized-cost_{{i}}_{{j}}" class = "utilized-cost" value="{{line_itemobj.utilized_unit_cost}}"> </td>
                                 <td> <input type="number" name ="variance_{{i}}_{{j}}_{{line_itemobj.id}}" id="variance_{{i}}_{{j}}" readonly="readonly" value="{{line_itemobj.variance}}"> </td>
                                 {% get_comment line_itemobj as comment %}
                                  <td> <input type="text" name = "comment_{{i}}_{{j}}_{{line_itemobj.id}}" id="comment_{{i}}_{{j}}" value="{% if comment %}{{comment.text}} {% else %} {% endif %}"> </td>
                                 <input type="hidden" name="line_obj" value="{{line_itemobj.id}}">
                                 {% get_line_attach line_itemobj as attach %}
                                 <td><input type="file" class = 'file_input_id' style="border: 0px;" name = "attach_{{i}}_{{j}}_{{line_itemobj.id}}" id="attach_{{i}}_{{j}}" onchange = "return attach_error()" value="{% if attach %}{{attach.attachment_file}} {% else %} {% endif %}">{% if attach %}<a style="float:left" href={{image_url}}{{attach.image_url}} target="_blank">{{attach.name}}</a> {% endif %}</td>
                                     
                                 <script type="text/javascript">
                                    function attach_error(){
                                        $('#error').hide();
                                        var attach_list = $('input[type=file]').trigger('click');
                                        for(i=0;i<attach_list.length;i++){
                                            if($(attach_list[i]).val() != ""){
                                                if(attach_list[i].files[0].size > 1000000)
                                                {
                                                    $('#error').show();
                                                    $('#error').addClass('error_cls')
                                                    alert('File size should not exceed more than 1 Mb')
                                                }
                                            }
                                        }
                                    };
                                 </script>
                                 {% endfor %}
                                
                        </tr>
                        {% endwith %}
                        {% endfor %}
                        </tbody>
                    </table>
                    <div id = "error"> * File size should not exceed more than 1 Mb </div>
                </div>
        </div>
        
        <div class="click_buttons">
            <div class="link-right">
            <input type="submit" value="Save Budget Utilization" class="btn btn-success">
            </div> 
        </div>
        </form>
        {% endif %}
    </div>
</div>
</section>
<script type="text/javascript" src="/static/js/jquery.selectbox-0.2.js"></script>
<script type="text/javascript" src="/static/js/ddsmoothmenu.js"></script>
<script type="text/javascript" src="/static/js/jquery.mmenu.min.all.js"></script>
<script type="text/javascript" src="/static/js/common.js" /></script>
<script src="/static/js/jquery.nicescroll.min.js"></script>
 <script src="/static/js/easyResponsiveTabs.js" type="text/javascript"></script>
 <script src="/static/js/jquery.stickytable.min.js" type="text/javascript"></script>
 
 <script type="text/javascript">
   $(document).ready(function(){
       $("#quarter").change(function(){
       $("#filter_form").submit();
       });
   });
   $('#error').hide();
</script>

<script type = "text/javascript">
   $(document).ready(function(){
       var sts = "{{ quarter_key }}";
       if (sts != "None"){
           $("#quarter").val(sts);
       }
   });
</script>

<script type = "text/javascript">
   $(document).ready(function(){
       var sts = "{{ request.GET.year }}";
       if (sts != "None"){
           $("#year").val(sts);
       }
   });
</script>

<!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>-->
<script>
$(document).ready(function(){
            $('#year').change(function(){
               var year = this.value;
               $.ajax({
                   url : '/manage/quarter/list/',
                   type : 'GET',
                   dataType : 'json',
                   data: {'year':year,'budget_id':parseInt({{budgetobj.id}})},
                   success : function(data) {
                            var quarter_dict = data.quarter_list
                            $('#quarter').find('option').remove().end();
                            $('<option>', {value : "" }).html("---------").appendTo('#quarter');
                          for (var key in quarter_dict) {
                                if (quarter_dict.hasOwnProperty(key)) {
                                    var value = quarter_dict[key];
                                    $('select[id=quarter]').append("<option value='" + key + "'>" + value +"</option>");
                                }
        }
        /*
                      for(var i=0;i<data.quarter_list.length;i++){
                           $('select[name=quarter]').append('<option value="' + data.quarter_list[i].id + '">' + data.quarter_list[i].name +'</option>');
                       }
                       */
                   },
                       error : function() {
                       console.log('error');
                   }
                });
    });
    });

</script>

<script>
//Toggle
		
	$('.user-menu').on('click',function(){
		$('.dropdown-menu').slideDown(350);
	
	});
	$('.select-down').on('click',function(){
        $('.dropdown-menu1').slideDown(350);
          
    });
	
	$(document).ready(function(e) {	
		/*Content Show/Hide */
		$('.hide-cont').hide();
		$('.close-cont').hide();
		$('.view-cont').click(function(){
			$('.hide-cont').slideDown(350);
			$('.close-cont').show();
			$('.view-cont').hide();
		});
		$('.close-cont').click(function(){
			$('.hide-cont').slideUp(350);
			$('.close-cont').hide();
			$('.view-cont').show();
		});	
		$(document).trigger( "click" );
	});
	
	$(document).click(function(){
	
		$('.user-menu, .select-down').click(function(event){
			event.stopPropagation();
		});
	
		$('.dropdown-menu, .dropdown-menu1').slideUp(350);	 
	
	});		 
</script>


<script>
    $(document).ready(function() {
   $(".main-table").clone(true).appendTo('#boxscroll1').addClass('clone');   
 });
    </script>
    <script>
  $(document).ready(function() {
  
    $("#boxscroll").niceScroll({cursorborder:"",cursorcolor:"#949494",boxzoom:true,background:"#e3e5dd"}); // First scrollable DIV

    
  });
</script>


<script type="text/javascript">
    $(document).ready(function () {
        $('#horizontalTab').easyResponsiveTabs({
            type: 'default', //Types: default, vertical, accordion           
            width: 'auto', //auto or any width like 600px
            fit: true,   // 100% fit in a container
            closed: 'accordion', // Start closed if in accordion view
            activate: function(event) { // Callback function if tab is switched
                var $tab = $(this);
                var $info = $('#tabInfo');
                var $name = $('span', $info);

                $name.text($tab.text());

                $info.show();
            }
        });
		});
</script>



<script>
    $(document).ready(function()
    {
        function updateVariance()
        {
            nam = $(this).context.name.split('_')
            i = nam[3]
            j = nam[4]
            
            var planned_cost = parseFloat(document.getElementById("planned-cost_"+i+"_"+j).innerText);
//            var planned_cost = parseFloat($("#planned-cost_"+i+"_"+j).val());
            var utilized_cost = $(this).val();
            var total = +planned_cost - +utilized_cost;
            //var total = total.toFixed(2);
            
            if (total.toString() == 'NaN'){
                $("#variance_"+i+"_"+j).val('');
            }
            else{
                $("#variance_"+i+"_"+j).val(parseInt(total));
                /*if (+planned_cost > +utilized_cost) {
                    $("#variance_"+i+"_"+j).val('0');
                }
                else{
                $("#variance_"+i+"_"+j).val(parseInt(total));
                }
                */
            }
            /*
            var utlizedtotal = 0
            $("[id^=utilized_unit_cost_][id$=_"+parseInt(j)+"]").each(function(){
                utlizedtotal = +utlizedtotal + +$(this).val()
            })
            utilized_unit_cost_0_0_120
            alert(utlizedtotal);
            //$('#td1').html('hello world');
            $("#utilized_"+j).val(parseInt(utlizedtotal));
            */
        }
        $(document).on("change, keyup", ".utilized-cost", updateVariance);
    });
    
</script>
<style>
.error_cls{color:red;}
</style>

{% endblock %}
