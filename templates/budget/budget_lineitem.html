{% extends 'base.html' %}
{% block section %}
{% endblock %}
{% block content %}
<div class="row">
    <div class="white-box">
        <div class="budget_create">
            <h3>Create Budget</h3>
            <p>3. Add Budget Line Items</p>
        </div>
        <form id="ic_form" action=".?slug={{project_slug}}&budget_id={{budget_id}}" method = "post">
            {% csrf_token %}
            <div id="boxscroll1" class="table-scroll">
                <input type="hidden" name="count" value="6">
                <input type="hidden" name="slug" value="{{project_slug}}">
                <input type="hidden" name="budget_id" value="{{budget_id}}">
                <div class="sticky-table sticky-headers sticky-ltr-cells table-wrap">
                    <table class="table table-striped table-striped " id="example1" cellpadding="0" cellspacing="0" border="0">
                        <thead>
                            <tr class="sticky-row">
                                <td class = "sticky-cell table_first" colspan="7">&nbsp;</td>
                                {% for i,j in quarter_list.items %}
                                <td class="table-head" colspan="3">{{j}}</th>
                                    {% endfor %}
                            </tr>
                            <tr class="sticky-row">
                                <th class="sticky-cell">&nbsp;</th>
                                <th class="sticky-cell">&nbsp;</th>
                                <th class="sticky-cell">Super Category</th>
                                <th class="sticky-cell">Heading</th>
                                <th class="sticky-cell">Subheading</th>
                                <th class="sticky-cell">Line Total</th>
                                <th class="sticky-cell">Unit Type</th>
                                {% for i,j in quarter_list.items %}
                                <th> No. of unit </th>
                                <th> Rate </th>
                                <th> Total Planned </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody class="budget_section">
                            {% for j in "123456"%}
                            {% with forloop.counter as rnum %}
                            <tr class = "data_row">
                                <td class="sticky-cell"><span></span></td>
                                <td class="sticky-cell"><span class="init">{{rnum}}</span></td>
                                <td class="sticky-cell">
                                    <select name="location_{{j}}" id="location_{{j}}" class="location">
                                        <option value = "">Select option </option>
                                        {% for i in supercategory_list %}
                                        <option value="{{i.id}}">{{i.name}}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td class="sticky-cell">
                                    <select name="heading_{{j}}" id="heading_{{j}}" class="heading">
                                        <option value = "">Select Heading </option>
                                        {% for i in heading_list %}
                                        <option value="{{i.id}}">{{i.name}}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td class="sticky-cell"><input type="text" class ="subheading" id="subheading_{{j}}" name="subheading_{{j}}"></td>
                                <td class="sticky-cell"><input type="number" class = "linetotal" name = "linetotal_{{j}}" id="linetotal_{{j}}" readonly="readonly"></td>
                                <td class="sticky-cell"><input type="text" class="unit-type" name = "unit-type_{{j}}" id="unit-type_{{j}}"> </td>
                                {% for i,v in quarter_list.items %}
                                <td class=""> <input type="number" name = "unit_{{i}}_{{j}}" class="unit" id="unit_{{i}}_{{j}}" > </td>
                                <td class=""> <input type="number" name = "rate_{{i}}_{{j}}" class="rate" id="rate_{{i}}_{{j}}"> </td>
                                <td class=""> <input type="number" name = "planned-cost_{{i}}_{{j}}" class ="planned-cost" id="planned-cost_{{i}}_{{j}}" readonly="readonly" > </td>
                                <!--                 <td> <input type="number" name = "utilized-cost_{{i}}_{{j}}"> </td>-->
                                {% endfor %}
                            </tr>
                            {% endwith %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="click_buttons">
                <div class="link-left">
                    <input type="hidden"/>
                    <a href ="javascript:void(0);" class ="link-pad add_clone">+Add more Lines</a>
                </div>
                <div class="link-center">
                    <input type="hidden"/>
                    <a href ="javascript:void(0);" class ="link-pad1 remove">Remove</a>
                </div>
                <div class="link-right">
                    <input type="submit" value="Save Budget Lineitems" class="btn btn-success">
                </div>
            </div>
    </div>
</div>
</form>
<script type="text/javascript" src="js/jquery.scrollbox.js"></script>
<script>
    $(document).ready(function() {
    $(".main-table").clone(true).appendTo('#boxscroll1').addClass('clone');   
    });
</script>
<!--<script>-->
<!--    $(document).ready(function() {-->
<!--    -->
<!--      $("#boxscroll").niceScroll({cursorborder:"",cursorcolor:"#949494",boxzoom:true,background:"#e3e5dd"}); // First scrollable DIV-->
<!--    -->
<!--    -->
<!--      -->
<!--    });-->
<!--</script>-->
<script src="/static/js/jquery.nicescroll.min.js"></script>
<script src="/static/js/easyResponsiveTabs.js" type="text/javascript"></script>
<script src="/static/js/jquery.stickytable.min.js" type="text/javascript"></script>

<script type="text/javascript">
    $(document).ready(function () {
        $('#horizontalTab').easyResponsiveTabs({
            type: 'default', //Types: default, vertical, accordion           
            width: 'auto', //auto or any width like 600px
            fit: true,   // 100% fit in a container
            closed: 'accordion', // Start closed if in accordion view
            activate: function(event) { // Callback function if tab is switched
                var $tab = $(this);
                var $info = $('#tabInfo');
                var $name = $('span', $info);
    
                $name.text($tab.text());
    
                $info.show();
            }
        });
    });
</script>
<script type="text/javascript">
    $(document).ready(function () 
    {
        $("[id$=_1]").attr('required', 'required')
        function mandatory_input()
        {
            sname = $(this).context.name.split('_');
            if (sname.length == 2){
                $("[id$=_"+parseInt(sname[1])+"]").attr('required', 'required')
            }
            else{
                        $("[id$=_"+parseInt(sname[2])+"]").attr('required', 'required')
            }
            }
            $(document).on("change, keyup", "#example1 tbody tr td input", mandatory_input);
            $(document).on("change, keyup", "#example1 tbody tr td select", mandatory_input);

       $( "#ic_form" ).submit(function( event ) {
            var linetotal_amount = 0
            var total_amount = "{{project_amount}}"
            $("[id^=linetotal_]").each(function(){
                linetotal_amount = +linetotal_amount + +$(this).val()
            })
            if (linetotal_amount >= total_amount){
                var remaining_amount = linetotal_amount - total_amount
                alert("Budget is higher than the budget mentioned earlier by: Rs."+ remaining_amount.toString())
            }
            else{
                var remaining_amount = total_amount - linetotal_amount
                alert("Budget is lower than the budget mentioned earlier")
            }
        });
    });
    
</script>
<script>
    $(document).ready(function()
    {
        function updatePrice()
        {
            nam = $(this).context.name.split('_')
            i = nam[1]
            j = nam[2]
            
            var rate = parseFloat($("#rate_"+i+"_"+j).val());
            var unit = parseFloat($("#unit_"+i+"_"+j).val());
            var total = (rate) * (unit);
            //var total = total.toFixed(2);
            if (total.toString() == 'NaN'){
                $("#planned-cost_"+i+"_"+j).val('');
            }
            else{
                $("#planned-cost_"+i+"_"+j).val(parseInt(total));
            }
            
            var linetotal = 0
            $("[id^=planned-cost_][id$=_"+parseInt(j)+"]").each(function(){
                linetotal = +linetotal + +$(this).val()
            })
            
            $("#linetotal_"+j).val(parseInt(linetotal));
        }
        $(document).on("change,blur, keyup", ".rate", updatePrice);
        $(document).on("change,blur, keyup", ".unit", updatePrice);
    });
    
</script>
<!--/*script for add more functionality-->
<script type="text/javascript">
    $(document).ready(function(){
                function clone(){
                    var count = $('input[name=count]').val();
                    var c = count;
                    var tR = $('.data_row:last').clone();
                    count++; /* To increase the count */
                    /* further functionalitie to split the name and append row number to each input type */
                    $(tR).find('td input, td select').each(function(){
                      if ($(this).attr('name')){
                           if ($(this).attr('name').split('_').length == 3){
                              var name = $(this).attr('name').split('_');
                              $(this).attr('name', name[0]+"_"+name[1]+"_"+count);
                              $(this).attr('id', name[0]+"_"+name[1]+"_"+count);
                            }
                            else if ($(this).attr('name').split('_').length == 2){
                              var name = $(this).attr('name').split('_');
                              $(this).attr('name', name[0]+"_"+count);
                              $(this).attr('id', name[0]+"_"+count);
                            }
                      }
                    });
                    $('input[name=count]').val(count)
                    $(tR).find('td span.init').text(count);
                    $(tR).insertAfter('.data_row:last');
                    }
                function remove(){
                    var count = $('input[name=count').val();
                      if (count > 1) {
                            $('tr.data_row:last').remove();
                            count  = $('tr.data_row').length;
                            $('input[name=count]').val(count);
                      }
                      else{
                        alert("Please add atleast one record")
                      }
                }
            $(".add_clone").on("click", clone);
            $(".remove").on("click", remove);
    
    });
</script>
{% endblock %}
