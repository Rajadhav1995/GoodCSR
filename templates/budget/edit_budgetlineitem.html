{% extends 'base.html' %}
{% load urs_tags %}
{% block section %}
{% endblock %}
{% block content %}

</br>

<section class="content-part forms_section">
<div class="row">

      
    <div class="white-box">
        <div class="budget_create">
            <h3>Budget Lineitem Edit for <a class="active" href="/manage/project/budget/view/?slug={{projectobj.slug}}&key=budget"> {{projectobj.name|title}} </a></h3>
            <p> Update Budget Line Items</p>

<form id="ic_form" action=".?slug={{project_slug}}&budget_id={{budget_id}}" method = "post" >{% csrf_token %}

        <div id="boxscroll1" class="table-scroll">
                <input type="hidden" name="count" value="{{budget_period|length|add:'-1'}}">
                <input type="hidden" name="slug" value="{{project_slug}}">
                <input type="hidden" name="budget_id" value="{{budget_id}}">
                <div class="sticky-table sticky-headers sticky-ltr-cells table-wrap">
                    <table class="table table-striped table-striped " id="example1" cellpadding="0" cellspacing="0" border="0">
                        <thead>
                            <tr class="sticky-row">
                              <td class = "sticky-cell table_first" colspan="7">&nbsp;</td>	
                              {% for i,j in quarter_list.items %}
                                    <td class="table-head" colspan="3">{{j}}</th>
                            {% endfor %}
                            </tr>
                            <tr class="sticky-row">
                                 <th class="sticky-cell">&nbsp;</th>
                                <th class="sticky-cell">&nbsp;</th>
                                <th class="sticky-cell">Super Category</th>
                                <th class="sticky-cell">Heading</th>
                                <th class="sticky-cell">Subheading</th>
                                <th class="sticky-cell">Line Total</th>
                                <th class="sticky-cell">Unit Type</th>
                                {% for i,j in quarter_list.items %}
                                <th> No. of unit </th>
                                <th> Rate </th>
                                <th> Total Planned </th>
<!--                                <th> Total Utilized </th>-->
<!--                                <th> Variance </th>-->
<!--                                <th> Comment </th>-->
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody class="budget_section">
                        {% for j in budget_period %}
                        {% with forloop.counter as rnum %}
                        <tr id="data_row_{{j}}" class = "data_row">
                            {% get_budget_lineitem j projectobj as lineitemobj %}
                            <td class="sticky-cell"><a type="button" title="Click here to delete the row" class="btn btn-danger delete_function"><span  onclick='return removerow({{j}})' name='removerow_{{j}}' id='removerow_{{j}}' class='removerow'>X</span> </a> </td>
                            <td class="sticky-cell"><span class="init">{{rnum}}<span></td>
                            
                            <td class="sticky-cell">
                                    <select name="location_{{j}}" id="location_{{j}}" class="location">
                                        <option value = "">Select option </option>
                                        {% for i in supercategory_list %}
                                        <option value="{{i.id}}" {% if lineitemobj.category.id == i.id %} selected="selected" {% endif %} >{{i.name}}</option>
                                        {% endfor %}
                                    </select>
                            </td>
                            <td class="sticky-cell">
                                    <select name="heading_{{j}}" id="heading_{{j}}" class="heading">
                                        <option value = "">Select Heading </option>
                                        {% for i in heading_list %}
                                        <option value="{{i.id}}" {% if lineitemobj.heading.id == i.id %} selected="selected" {% endif %}>{{i.name}}</option>
                                        {% endfor %}
                                    </select>
                            </td>
                            
<!--                            <td class="fixed-side"> {{lineitemobj.category.name}}</td>-->
<!--                            <td class="fixed-side"> {{lineitemobj.heading.name}} </td>-->
                            <td class="sticky-cell"> <input type="text" class ="subheading" id="subheading_{{j}}" name="subheading_{{j}}" value="{{lineitemobj.subheading}}">  </td>
                            {% get_line_total j projectobj as line_total %}
                            <td class="sticky-cell"><input onfocus="if(this.value == '0') {this.value=''}" onblur="if(this.value == ''){this.value ='0'}" type="number" class = "linetotal" name = "linetotal_{{j}}" id="linetotal_{{j}}" readonly="readonly" value="{{line_total}}"></td>
                            <td class="sticky-cell"> <input type="text" class="unit-type" name = "unit-type_{{j}}" value="{{lineitemobj.unit_type}}"></td>
                                {% for i,v in quarter_list.items %}
                                {% get_quarter_details j i projectobj as line_itemobj %}
                               <td> <input step=any onfocus="if(this.value == '0') {this.value=''}" onblur="if(this.value == ''){this.value ='0'}" type="number" name = "unit_{{i}}_{{line_itemobj.id}}_{{j}}" class="unit" id="unit_{{i}}_{{j}}" value="{{line_itemobj.unit}}" > </td>
                                <td><input step=any onfocus="if(this.value == '0') {this.value=''}" onblur="if(this.value == ''){this.value ='0'}" type="number" name = "rate_{{i}}_{{line_itemobj.id}}_{{j}}" class="rate" id="rate_{{i}}_{{j}}" value="{{line_itemobj.rate}}"> </td>
                                 <td> <input step=any onfocus="if(this.value == '0') {this.value=''}" onblur="if(this.value == ''){this.value ='0'}" type="number" name = "planned-cost_{{i}}_{{line_itemobj.id}}_{{j}}" class ="planned-cost" id="planned-cost_{{i}}_{{j}}" readonly="readonly" value ="{{line_itemobj.planned_unit_cost}}"> </td>
                                 
<!--                                 <td> <input type="number" name = "utilized-unit-cost_{{i}}_{{line_itemobj.id}}_{{j}}"  id = "utilized-cost_{{i}}_{{j}}" class = "utilized-cost" value="{{line_itemobj.utilized_unit_cost}}"> </td>-->
<!--                                 <td> <input type="number" name ="variance_{{i}}_{{line_itemobj.id}}_{{j}}" id="variance_{{i}}_{{j}}" readonly="readonly" value="{{line_itemobj.variance}}"> </td>-->
<!--                                 {% get_comment line_itemobj as comment %}-->
<!--                                  <td> <input type="text" name = "comment_{{i}}_{{line_itemobj.id}}_{{j}}" id="comment_{{i}}_{{j}}" value="{% if comment %}{{comment.text}} {% else %} {% endif %}"> </td>-->
                                 <input type="hidden" name="line_obj" value="{{line_itemobj.id}}">
                                 {% endfor %}
                        </tr>
                        {% endwith %}
                        {% endfor %}
                        </tbody>
                    </table>
                    
<!--                    for extra row-->
                     <table class="table table-striped table-striped " id="example1" cellpadding="0" cellspacing="0" border="0">
                        <thead>
                        </thead>
                          <tr class="sticky-row">
                        <tbody class="budget_section">
                      
                            <td class="sticky-cell" style="padding:10px 20.5px;top:0px" ></td>

                            <td class="sticky-cell"  style="top:0px;padding-left:390px;padding-right:123px"><input type="number" class = "linetotal" name = "lastrow_linetotal" id="lastrow_linetotal" readonly="readonly" value="{{line_total}}"></td>

                            {% for i,v in quarter_list.items %}
                            
                                 <td style="top:0px;padding-left:326px;padding-right:8px" > <input type="number" name = "quarter_linetotal_{{i}}" class ="planned-cost" id="quarter_linetotal_{{i}}" readonly="readonly" value =""> </td>
                                 <input type="hidden" name="line_obj" value="{{line_itemobj.id}}">
                            {% endfor %}
                        
                        </tbody>
                        </tr>
                    </table>
</div>

                
        </div>
        
        <div class="click_buttons">
            <div class="link-left">
                <input type="hidden"/>
                <a href ="javascript:void(0);" class ="link-pad add_clone">+Add more Lines</a>
            </div>
            <div class="link-center">
                <input type="hidden"/>
<!--                <a href ="javascript:void(0);" class ="link-pad1 remove">Remove</a>-->
            </div>

            <div class="link-right">
            <input type="submit" value="Save Budget Utilization" class="btn btn-success">
            </div> 
        </div>
        </form>
    </div>
</div>
</section>
<script type="text/javascript" src="/static/js/jquery.selectbox-0.2.js"></script>
<script type="text/javascript" src="/static/js/ddsmoothmenu.js"></script>
<script type="text/javascript" src="/static/js/jquery.mmenu.min.all.js"></script>
<script type="text/javascript" src="/static/js/common.js" /></script>
<script src="/static/js/jquery.nicescroll.min.js"></script>
<script src="/static/js/easyResponsiveTabs.js" type="text/javascript"></script>
<script src="/static/js/jquery.stickytable.min.js" type="text/javascript"></script>
 
 <script type="text/javascript">
   $(document).ready(function(){
       $("#quarter").change(function(){
       $("#filter_form").submit();
       });
   });
</script>

<script>
$(document).ready(function (){
  quartercount();
  
  totalcount();
});
</script>

<script type = "text/javascript">
   $(document).ready(function(){
       var sts = "{{ quarter_key }}";
       if (sts != "None"){
           $("#quarter").val(sts);
       }
       
       $( "#ic_form" ).submit(function( event ) {
            var linetotal_amount = 0
            var total_amount = "{{project_amount}}"
            $("[id^=linetotal_]").each(function(){
                linetotal_amount = +linetotal_amount + +$(this).val()
            })
            if (linetotal_amount >= total_amount){
                var remaining_amount = linetotal_amount - total_amount
                alert("Budget is higher than the budget mentioned earlier by: Rs."+ remaining_amount.toString())
            }
            else{
                var remaining_amount = total_amount - linetotal_amount
                alert("Budget is lower than the budget mentioned earlier")
            }
        });
   });
</script>

<script type="text/javascript">
    $(document).ready(function () 
    {
        $("[id$=_1]").attr('required', 'required')
        function mandatory_input()
        {
            sname = $(this).context.name.split('_');
            
            if (sname.length == 2){
                $("[id$=_"+parseInt(sname[1])+"]").attr('required', 'required')
            }
            else{
                        $("[id$=_"+parseInt(sname[2])+"]").attr('required', 'required')
            }
            }
            $(document).on("change, keyup", "#example1 tbody tr td input", mandatory_input);
            $(document).on("change, keyup", "#example1 tbody tr td select", mandatory_input);
    });
    
</script>


<script type = "text/javascript">
   $(document).ready(function(){
       var sts = "{{ request.GET.year }}";
       if (sts != "None"){
           $("#year").val(sts);
       }
   });
</script>




<script>
    $(document).ready(function()
    {
        function updatePrice()
        {
            nam = $(this).context.name.split('_')
            i = nam[1]
            j = nam[3]
            
            var rate = parseFloat($("#rate_"+i+"_"+j).val());
            var unit = parseFloat($("#unit_"+i+"_"+j).val());
            var total = (rate) * (unit);
            //var total = total.toFixed(2);
            if (total.toString() == 'NaN'){
                $("#planned-cost_"+i+"_"+j).val('');
            }
            else{
                $("#planned-cost_"+i+"_"+j).val(parseFloat(total));
            }
            
            var linetotal = 0
            $("[id^=planned-cost_][id$=_"+parseInt(j)+"]").each(function(){
                linetotal = +linetotal + +$(this).val()
            })
            
            $("#linetotal_"+j).val(parseFloat(linetotal));
            quartercount();
            totalcount();
        }
        $(document).on("change,blur, keyup", ".rate", updatePrice);
        $(document).on("change,blur, keyup", ".unit", updatePrice);
    });
    
</script>

<!--/*script for add more functionality-->
<script type="text/javascript">
    $(document).ready(function(){
                function clone(){
                    var count = $('input[name=count]').val();
                    
                    var c = count;
                    var tR = $('.data_row:last').clone();
                    var lastid = $(".data_row:last").attr("id");
                    count++; /* To increase the count */
                    /* further functionalitie to split the name and append row number to each input type */
                    $(tR).attr('id', "data_row_"+count);
                    $(tR).find('td input, td select, td span, td a span').each(function(){
                      $(this).val('')
                      if ($(this).attr('name')){
                           if ($(this).attr('name').split('_').length == 3){
                              var name = $(this).attr('name').split('_');
                              $(this).attr('name', name[0]+"_"+name[1]+"_"+" "+"_"+count);
                              $(this).attr('id', name[0]+"_"+name[1]+"_"+count);
                              this.value='0'
                            }
                            else if ($(this).attr('name').split('_').length == 2){
                              var name = $(this).attr('name').split('_');
                              $(this).attr('name', name[0]+"_"+count);
                              $(this).attr('id', name[0]+"_"+count);
                              if (name[0]=='linetotal') {
                                
                                this.value=0;
                              };
                              if (name[0].startsWith('removerow') == true){
                                    $(this).attr('onclick', "return removerow("+count+")");
                                }
                            }
                            else if ($(this).attr('name').split('_').length == 4){
                              
                              var name = $(this).attr('name').split('_');
                              $(this).attr('name', name[0]+"_"+name[1]+"_"+""+"_"+count);
                              $(this).attr('id', name[0]+"_"+name[1]+"_"+count);
                              this.value='0'
                            }
                      }
                    });
                    $('input[name=count]').val(count)
                    var ct = parseInt($('input[name=count]').val()) + parseInt(1)
                    $(tR).find('td span.init').text(ct);
                    $(tR).insertAfter('.data_row:last');

//---------------------to change the count of number 
                    var count_div = $("[id^=data_row_]").length;
                        abc = 0;
                        for (i=0;i<=count_div;i++){
                            var tR = $('#data_row_'+i)
                            if (tR.length != 0){
                            $(tR).find('td span.init').each(function(){
                                var ct = parseInt(abc+1)
                                abc++
                                $(this).text(ct)
                                
                        })
                    }
                            }

                    }
                function remove(){
                    var count = $('input[name=count').val();
                      if (count > 0) {
                            $('tr.data_row:last').remove();
                            count  = parseInt($('tr.data_row').length) - parseInt(1);
                            $('input[name=count]').val(count);
                      }
                      else{
                        alert("Please add atleast one record")
                      }
                }

            $(".add_clone").on("click", clone);
            $(".remove").on("click", remove);
    
    });
</script>

<script>
                function removerow(j){
                 //var split_id = id.split("_");
                 //var deleteindex = split_id[1];
                 
                    var result = confirm("Are you sure to delete this row?");
                    if (result) {
                        //Logic to delete the item
                        $("#data_row_" + j).remove();
                        
                        var count_div = $("[id^=data_row_]").length;
                        abc = 0;
                        for (i=0;i <= count_div;i++){
                            var tR = $('#data_row_'+i)
                            alert(tR.length+"i value"+i)
                            if (tR.length != 0){
                                //alert(abc+"meghana")
                                    $(tR).find('td span.init').each(function(){
                                    var ct = parseInt(abc+1)
                                    abc++
                                    $(this).text(ct)
                                
                        })
                    }
                        else{
                        alert("hi"+abc)
                        }
                            }
                        quartercount();
                        totalcount();
                           
                    }
                  // Remove <div> with id
                  
                }
                
</script>

<script>
        function totalcount()
        {
        linetotal_amount = 0
        $("[id^=linetotal_]").each(function(){
                linetotal_amount = +linetotal_amount + +$(this).val()
            })
            $("#lastrow_linetotal").val(parseInt(linetotal_amount));
        }
        $(document).on("change,blur, keyup", ".rate", totalcount);
        $(document).on("change,blur, keyup", ".unit", totalcount);
    
</script>


<script>
        function quartercount()
        {
        {% for i,v in quarter_list.items %}
            quartertotal_amount = 0
            $('[id^=planned-cost_{{i}}]').each(function(){
                    quartertotal_amount = +quartertotal_amount + +$(this).val()
                    $("#quarter_linetotal_{{i}}").val(parseInt(quartertotal_amount));
                })
        {% endfor %}
        }
        $(document).on("change,blur, keyup", ".rate", quartercount);
        $(document).on("change,blur, keyup", ".unit", quartercount);

</script>

<script>
//Toggle
		
	$('.user-menu').on('click',function(){
		$('.dropdown-menu').slideDown(350);
	
	});
	$('.select-down').on('click',function(){
        $('.dropdown-menu1').slideDown(350);
          
    });
	
	$(document).ready(function(e) {	
		/*Content Show/Hide */
		$('.hide-cont').hide();
		$('.close-cont').hide();
		$('.view-cont').click(function(){
			$('.hide-cont').slideDown(350);
			$('.close-cont').show();
			$('.view-cont').hide();
		});
		$('.close-cont').click(function(){
			$('.hide-cont').slideUp(350);
			$('.close-cont').hide();
			$('.view-cont').show();
		});	
		$(document).trigger( "click" );
	});
	
	$(document).click(function(){
	
		$('.user-menu, .select-down').click(function(event){
			event.stopPropagation();
		});
	
		$('.dropdown-menu, .dropdown-menu1').slideUp(350);	 
	
	});		 
</script>


<script>
    $(document).ready(function() {
   $(".main-table").clone(true).appendTo('#boxscroll1').addClass('clone');   
 });
    </script>
    <script>
  $(document).ready(function() {
  
    $("#boxscroll").niceScroll({cursorborder:"",cursorcolor:"#949494",boxzoom:true,background:"#e3e5dd"}); // First scrollable DIV

    
  });
</script>


<script type="text/javascript">
    $(document).ready(function () {
        $('#horizontalTab').easyResponsiveTabs({
            type: 'default', //Types: default, vertical, accordion           
            width: 'auto', //auto or any width like 600px
            fit: true,   // 100% fit in a container
            closed: 'accordion', // Start closed if in accordion view
            activate: function(event) { // Callback function if tab is switched
                var $tab = $(this);
                var $info = $('#tabInfo');
                var $name = $('span', $info);

                $name.text($tab.text());

                $info.show();
            }
        });
		});
</script>

<!--<script>-->

<!--    $(document).ready(function()-->
<!--    {-->
<!--        function updateVariance()-->
<!--        {-->
<!--            nam = $(this).context.name.split('_')-->
<!--            i = nam[1]-->
<!--            j = nam[3]-->
<!--            -->
<!--            var planned_cost = parseFloat($("#planned-cost_"+i+"_"+j).val());-->
<!--            var utilized_cost = $(this).val();-->
<!--            var total = +planned_cost - +utilized_cost;-->
<!--            //var total = total.toFixed(2);-->
<!--            -->
<!--            if (total.toString() == 'NaN'){-->
<!--                $("#variance_"+i+"_"+j).val('');-->
<!--            }-->
<!--            else{-->
<!--                $("#variance_"+i+"_"+j).val(parseInt(total));-->
<!--                /*if (+planned_cost > +utilized_cost) {-->
<!--                    $("#variance_"+i+"_"+j).val('0');-->
<!--                }-->
<!--                else{-->
<!--                $("#variance_"+i+"_"+j).val(parseInt(total));-->
<!--                }-->
<!--                */-->
<!--            }-->
<!--            -->
<!--            -->
<!--        }-->
<!--        $(document).on("change, keyup", ".utilized-cost", updateVariance);-->
<!--        $(document).on("change,blur, keyup", ".rate", updateVariance);-->
<!--        $(document).on("change,blur, keyup", ".unit", updateVariance);-->
<!--    });-->
<!--    -->
<!--</script>-->


{% endblock %}
